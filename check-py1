import os
import azure.functions as func
from openai import AzureOpenAI

# Read settings from environment variables (set via Terraform app_settings)
AZURE_ENDPOINT = os.environ.get("AZURE_OPENAI_ENDPOINT")
AZURE_API_KEY = os.environ.get("AZURE_OPENAI_API_KEY")
AZURE_API_VERSION = os.environ.get("OPENAI_API_VERSION", "2025-03-01-preview")
AZURE_MODEL = os.environ.get("AZURE_OPENAI_DEPLOYMENT")

# Initialize Azure OpenAI client
client = AzureOpenAI(
    azure_endpoint=AZURE_ENDPOINT,
    api_key=AZURE_API_KEY,
    api_version=AZURE_API_VERSION,
)

app = func.FunctionApp()

@app.function_name(name="ChatBot")
@app.route(route="chat", methods=["POST"])
def chat(req: func.HttpRequest) -> func.HttpResponse:
    try:
        body = req.get_json()
        user_msg = body.get("message", "Hello!")
        
        # Call Azure OpenAI Responses API
        response = client.responses.create(
            model=AZURE_MODEL,
            input=[{"role": "user", "content": user_msg}],
        )

        # Extract reply text
        try:
            reply = response.output[0].content[0].text
               except Exception:
            reply = str(response)

        return func.HttpResponse(reply, status_code=200)

    except Exception as e:
